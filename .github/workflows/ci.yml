name: API Framework CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout framework repo
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Clone Restful-Booker SUT
        run: git clone https://github.com/mwinteringham/restful-booker sut-restful-booker

      - name: Start Restful-Booker (Docker Compose + Mongo)
        run: |
          cd sut-restful-booker

          cat > docker-compose.ci.yml <<EOF
version: '2'
services:
  mongo:
    image: mongo:6
    restart: always
    ports:
      - "27017:27017"

  restful-booker:
    depends_on:
      - mongo
    environment:
      DB_HOST: mongo
      DB_PORT: 27017
      MONGO_URL: mongodb://mongo:27017
  EOF
  
  docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v || true
  docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d --build
  docker compose -f docker-compose.yml -f docker-compose.ci.yml ps

- name: Wait for API readiness (CRUD endpoint)
  run: |
    for i in {1..90}; do
      code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/booking || true)
    
      if [ "$code" = "200" ]; then
        echo "API ready! /booking returned 200"
        exit 0
      fi
    
      echo "Waiting... /booking -> $code"
      echo "Ping:"
      curl -i http://localhost:3001/ping || true
    
      echo "SUT logs (tail):"
      cd sut-restful-booker
      docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color --tail=200 || true
      cd ..
    
      sleep 2
    done
    
    echo "API did not become ready in time"
    exit 1

- name: Run TestNG suite against local SUT
  run: mvn test -DsuiteXmlFile=testng.xml -Dbase.url=http://localhost:3001

- name: SUT logs on failure
  if: failure()
  run: |
    cd sut-restful-booker
    docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color
