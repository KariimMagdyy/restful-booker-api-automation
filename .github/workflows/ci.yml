name: API Framework CI (Local SUT via Docker)

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      # Change these to match your SUT
      SUT_REPO_URL: https://github.com/KariimMagdyy/restful-booker
      SUT_DIR: sut
      SUT_BASE_URL: http://localhost:3001
      SUT_HEALTH_PATH: /ping

    steps:
      # 1) Checkout YOUR automation framework repo
      - name: Checkout automation framework
        uses: actions/checkout@v4

      # 2) Setup Java + Maven cache
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      # 3) Install docker compose (usually already available, but safe)
      - name: Verify Docker & Compose
        run: |
          docker --version
          docker compose version

      # 4) Clone SUT repo
      - name: Clone SUT repo
        run: git clone "$SUT_REPO_URL" "$SUT_DIR"

      # 5) Start SUT via Docker Compose
      - name: Start SUT (Docker Compose)
        working-directory: ${{ env.SUT_DIR }}
        run: |
          docker compose down -v || true
          docker compose up -d --build
          docker compose ps

      # 6) Wait until SUT is ready
      - name: Wait for SUT readiness
        run: |
          echo "Waiting for SUT at $SUT_BASE_URL$SUT_HEALTH_PATH ..."
          for i in {1..60}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$SUT_BASE_URL$SUT_HEALTH_PATH" || true)
            if [ "$code" = "201" ] || [ "$code" = "200" ]; then
              echo "SUT is ready (HTTP $code)."
              exit 0
            fi
            echo "Not ready yet (HTTP $code). retrying..."
            sleep 2
          done

          echo "SUT did not become ready in time."
          echo "Printing container logs..."
          docker compose -f "${{ env.SUT_DIR }}/docker-compose.yml" logs --no-color || true
          exit 1

      # 7) Run your API tests
      - name: Run smoke tests
        run: |
          mvn test \
          -Dsurefire.suiteXmlFiles=testng-smoke.xml \
          -Dbase.url="${SUT_BASE_URL}"



      # 8) Always collect useful artifacts
      - name: Upload surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            target/surefire-reports/**
            target/failsafe-reports/**
          if-no-files-found: ignore

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results


      # 9) Always stop SUT + upload docker logs (helps debugging CI failures)
      - name: Docker logs (SUT)
        if: always()
        run: |
          docker compose -f "${{ env.SUT_DIR }}/docker-compose.yml" logs --no-color > sut-docker-logs.txt || true

      - name: Upload SUT docker logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sut-docker-logs
          path: sut-docker-logs.txt
          if-no-files-found: ignore

      - name: Stop SUT
        if: always()
        working-directory: ${{ env.SUT_DIR }}
        run: |
          docker compose down -v || true
